import{_ as me}from"./AppLayout.vue_vue_type_script_setup_true_lang-Ct8JXGRP.js";import{i as fe,a as ge,b as ye,c as _e,F as we}from"./FullCalendar-CKJTkntB.js";import{d as be,r as g,K as ke,c as he,L as v,j as w,m as h,e as Se,H as xe,M as m,y as S,o as x,s as l,b as p,g as q,p as s,h as f,u as L,P as Ce,N as K,t as A,S as De,O as Ee}from"./app-CKRJY2F8.js";import{_ as Me}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-Bcb3fFpx.js";import"./useForwardExpose-B07MqVxp.js";import"./VisuallyHidden-DZ6F9zcq.js";import"./RovingFocusGroup-CatCWtpt.js";import"./useArrowNavigation-C6Y-ieo6.js";import"./index-CaeFeOCz.js";import"./createLucideIcon-BNKRMJ0R.js";const Ye={class:"h-full w-full"},Te={class:"ring-latte-200/70 h-full overflow-hidden bg-white/95 shadow-[0_8px_30px_rgb(0,0,0,0.06)] ring-1"},Ge={class:"flex items-center justify-between border-b border-black/5 px-3 py-2"},Oe={class:"flex items-center gap-2"},Ie={class:"grid grid-cols-1 gap-3 md:grid-cols-2"},$e={class:"flex items-center gap-2"},Pe={class:"grid grid-cols-1 gap-3 md:grid-cols-2"},Le={class:"grid grid-cols-1 gap-3 md:grid-cols-2"},ze={class:"mt-4 flex justify-between"},Ae="AIzaSyCNDRzrfwUyoz9W5P9ksd8VQPnvIuu1V0M",Re="YYYY-MM-DDTHH:mm:ssZ",Ne=be({__name:"Index",setup(Fe){const C=g(!1),D=g(!1);async function Z(){await new Promise(e=>{gapi.load("client",async()=>{await gapi.client.init({apiKey:Ae,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]}),C.value=!0,e()})})}function X(e,t,a=600,i=700){if(typeof window>"u")return null;const o=window.top??window,d=Number(o.outerWidth||o.innerWidth||1200),u=Number(o.outerHeight||o.innerHeight||800),_=Number(o.screenX??o.screenLeft??0),G=Number(o.screenY??o.screenTop??0),O=Math.max(0,Math.round(_+(d-a)/2)),c=Math.max(0,Math.round(G+(u-i)/2));return window.open(e,t,`popup=yes,noopener,noreferrer,width=${a},height=${i},left=${O},top=${c}`)}function R(){const e=X("/oauth/google/redirect","google_oauth"),t=window.setInterval(async()=>{(!e||e.closed)&&(window.clearInterval(t),await z())},800)}async function z(){try{const{data:e}=await w.get("/api/integrations/google/access-token");return e?.connected&&e?.access_token?(gapi.client.setToken({access_token:e.access_token}),D.value=!0,!0):(D.value=!1,!1)}catch(e){return console.error(e),D.value=!1,!1}}async function Q(){try{await w.post("/api/integrations/google/revoke")}catch{}gapi.client.setToken(null),D.value=!1}const J=[{title:"Calendar",href:"calendar"}],E=e=>h(e).format(Re),N=()=>M.value?.getApi()?.refetchEvents(),M=g(),y=g([]),Y=g(!1),b=g(!1),k=g(!1),F=g(),n=ke({title:"",description:"",all_day:!1,start:"",end:"",color:"#1677ff",location:"",meta:{}}),T=g([]),ee=he(()=>Object.fromEntries(T.value.map(e=>[e.id,{name:e.summary,color:e.backgroundColor}])));function te(e,t={}){return new Promise((a,i)=>{const o=Array.from(document.scripts).find(u=>u.src===e);if(o){if(o.dataset.loaded==="1")return a();o.addEventListener("load",()=>a()),o.addEventListener("error",()=>i(new Error(`Failed to load ${e}`)));return}const d=document.createElement("script");d.src=e,d.async=!0,d.defer=!0,Object.entries(t).forEach(([u,_])=>d.setAttribute(u,_)),d.addEventListener("load",()=>{d.dataset.loaded="1",a()}),d.addEventListener("error",()=>i(new Error(`Failed to load ${e}`))),document.head.appendChild(d)})}async function ae(){return gapi?.client?.getToken?.()||await z()?!0:(v.warning("Please connect your Google account first."),R(),!1)}async function ne(){const e=[];let t;do{const a=await V(()=>gapi.client.calendar.calendarList.list({maxResults:250,pageToken:t}));e.push(...a.result.items??[]),t=a.result.nextPageToken}while(t);T.value=e.map(a=>({id:a.id,summary:a.summary,backgroundColor:a.backgroundColor}))}async function oe(e,t,a){const i=[];let o;do{const d=await V(()=>gapi.client.calendar.events.list({calendarId:e,timeMin:t,timeMax:a,showDeleted:!1,singleEvents:!0,maxResults:2500,orderBy:"startTime",pageToken:o}));i.push(...d.result.items??[]),o=d.result.nextPageToken}while(o);return i}function le(e,t){const a=e.start?.dateTime||e.start?.date,i=e.end?.dateTime||e.end?.date,o=!!(e.start?.date&&!e.start?.dateTime),d=ee.value[t]||{name:t};return{id:`gcal_${t}__${e.id}`,title:e.summary||"(no title)",description:e.description||null,all_day:o,start:o?h(a).format("YYYY-MM-DD"):E(a),end:i?o?h(i).format("YYYY-MM-DD"):E(i):null,color:d.color||"#722ed1",location:e.location||null,meta:{source:"google",calendarId:t,calendarName:d.name,htmlLink:e.htmlLink,attendees:e.attendees,organizer:e.organizer,raw:e}}}async function W(){const e=M.value?.getApi(),t=e?.view?.activeStart,a=e?.view?.activeEnd;if(!(!t||!a||!await ae()))try{if(Y.value=!0,await ne(),T.value.length===0){v.info("No calendars found on this account");return}const o=t.toISOString(),d=a.toISOString(),_=(await Promise.all(T.value.map(async c=>(await oe(c.id,o,d)).map($=>le($,c.id))))).flat(),G=c=>String(c.id).startsWith("gcal_"),O=c=>{const I=h(c.start),$=h(t),r=h(a);return I.isAfter($.subtract(1,"minute"))&&I.isBefore(r.add(1,"minute"))};y.value=[...y.value.filter(c=>!(G(c)&&O(c))),..._],_.forEach(c=>{B(c)}),v.success(`Synced ${_.length} Google events from ${T.value.length} calendars`),N()}catch(o){console.error(o),v.error(o?.message||"Failed to sync Google Calendars")}finally{Y.value=!1}}const H=async e=>{Y.value=!0;try{const{data:t}=await w.get("/events",{params:e||{}});y.value=t,N()}finally{Y.value=!1}},U=()=>{n.title="",n.description="",n.all_day=!1,n.start="",n.end="",n.color="#1677ff",n.location="",n.meta={},k.value=!1},j=(e,t)=>{U(),n.start=e,n.end=t||e,b.value=!0},se=e=>{U(),k.value=!0;const t=e.event.extendedProps.full||{id:String(e.event.id),title:e.event.title,all_day:e.event.allDay,start:e.event.start?.toISOString()||"",end:e.event.end?.toISOString()||"",color:e.event.backgroundColor||"#1677ff"};Object.assign(n,t),b.value=!0},re=async()=>{try{if(await F.value?.validate?.(),k.value&&n.id&&!String(n.id).startsWith("gcal_")){const{data:e}=await w.put(`/events/${n.id}`,n),t=y.value.findIndex(a=>a.id===e.id);t>-1&&(y.value[t]=e),v.success("Event updated")}else k.value?v.info("Google-synced events are read-only here."):await B(n);b.value=!1}catch(e){console.log(e)}},B=async e=>{const{data:t}=await w.post("/events",e);y.value.push(t),v.success("Event created")},ie=async()=>{if(n.id){if(String(n.id).startsWith("gcal_")){v.info("Delete Google events in Google Calendar directly.");return}await w.delete(`/events/${n.id}`),y.value=y.value.filter(e=>e.ID!==n.id),v.success("Event deleted"),b.value=!1}},de=g({height:"100%",eventDidMount(e){const t=e.event.extendedProps?.full?.color||e.event.backgroundColor||void 0;t&&(e.el.style.backgroundColor=t,e.el.style.borderColor=t,e.el.style.color="#fff",e.el.style.opacity="0.85")},plugins:[fe,ge,ye,_e],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today gsync",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"},customButtons:{gsync:{text:"Sync Google Calendar",click:async()=>{if(!C.value){v.loading("Loading Google libraries…",1);return}await W()}}},selectable:!0,editable:!0,selectMirror:!0,displayEventTime:!1,eventTimeFormat:{hour:"2-digit",minute:"2-digit"},select:e=>{const t=E(e.start),a=e.end?E(e.end):t;n.all_day=!!e.allDay||e.startStr.length===10,j(a,a)},eventClick:se,eventDrop:async e=>{const t=String(e.event.id);if(t.startsWith("gcal_")){e.revert(),v.info("Google-synced events are read-only here.");return}const a={start:e.event.start?.toISOString(),end:e.event.end?.toISOString()||null,all_day:e.event.allDay};await w.put(`/events/${t}`,a),v.success("Event moved")},eventResize:async e=>{const t=String(e.event.id);if(t.startsWith("gcal_")){e.revert(),v.info("Google-synced events are read-only here.");return}const a={start:e.event.start?.toISOString(),end:e.event.end?.toISOString()||null};await w.put(`/events/${t}`,a),v.success("Event resized")},datesSet:async e=>{await H({startStr:e.startStr,endStr:e.endStr})},events:(e,t)=>{t(y.value.map(a=>({id:String(a.id),title:a.title,start:a.start,end:a.end||void 0,allDay:a.all_day,backgroundColor:a.color||void 0,borderColor:a.color||void 0,extendedProps:{full:a}})))}});async function V(e){try{return await e()}catch(t){if(!(t?.status===401||t?.result?.error?.code===401||/invalid_credentials|unauthorized/i.test(String(t?.message??""))))throw t;try{const{data:i}=await w.get("/api/integrations/google/access-token",{params:{refresh:1}});if(i?.access_token)return gapi.client.setToken({access_token:i.access_token}),await e()}catch{}throw t}}Se(async()=>{await xe();const e=M.value?.getApi(),t=e?.view?.activeStart?.toISOString(),a=e?.view?.activeEnd?.toISOString();await H({startStr:t,endStr:a});try{await te("https://apis.google.com/js/api.js"),await Z()}catch(i){console.warn("Failed to load gapi",i)}C.value&&await z()});const ce=()=>{const e=M.value?.getApi()?.getDate()??new Date;j(E(h(e).startOf("day").toDate()))},ue=[{value:"#1677ff",label:"Blue"},{value:"#52c41a",label:"Matcha"},{value:"#faad14",label:"Caramel"},{value:"#f5222d",label:"Rose"},{value:"#722ed1",label:"Lavender"},{value:"#b08d57",label:"Oat"},{value:"#7cc4a4",label:"Pistachio"}];return(e,t)=>{const a=m("a-alert"),i=m("a-tag"),o=m("a-button"),d=m("a-input"),u=m("a-form-item"),_=m("a-textarea"),G=m("a-checkbox"),O=m("a-select"),c=m("a-date-picker"),I=m("a-form"),$=m("a-modal");return x(),S(me,{breadcrumbs:J},{default:l(()=>[p("div",Ye,[Y.value?(x(),S(a,{key:0,type:"info","show-icon":"",message:"Loading events...",class:"latte-alert mb-3"})):q("",!0),p("div",Te,[p("div",Ge,[t[16]||(t[16]=p("div",{class:"text-latte-500 text-sm"},"FullCalendar",-1)),p("div",Oe,[C.value?(x(),S(i,{key:0,color:"success",class:"rounded-full"},{default:l(()=>t[11]||(t[11]=[f("Google API Ready",-1)])),_:1,__:[11]})):(x(),S(i,{key:1,color:"default",class:"rounded-full"},{default:l(()=>t[12]||(t[12]=[f("Loading Google…",-1)])),_:1,__:[12]})),D.value?(x(),S(o,{key:3,size:"small",onClick:Q},{default:l(()=>t[14]||(t[14]=[f(" Disconnect ",-1)])),_:1,__:[14]})):(x(),S(o,{key:2,size:"small",onClick:R,disabled:!C.value},{default:l(()=>t[13]||(t[13]=[f(" Connect Google ",-1)])),_:1,__:[13]},8,["disabled"])),s(o,{type:"primary",size:"small",onClick:W,disabled:!C.value||!D.value},{default:l(()=>t[15]||(t[15]=[f(" Sync Google Calendar ",-1)])),_:1,__:[15]},8,["disabled"])])]),s(L(we),{ref_key:"calendarRef",ref:M,options:de.value},null,8,["options"])]),s(o,{class:"fab md:hidden",type:"primary",shape:"round",style:{zIndex:9999},onClick:t[0]||(t[0]=r=>ce())},{icon:l(()=>[s(L(Ce))]),default:l(()=>[t[17]||(t[17]=f(" Add ",-1))]),_:1,__:[17]}),s($,{open:b.value,"onUpdate:open":t[10]||(t[10]=r=>b.value=r),title:k.value?"Edit Event":"New Event",footer:null,"destroy-on-close":"",width:"560px"},{default:l(()=>[s(I,{ref_key:"formRef",ref:F,model:n,layout:"vertical"},{default:l(()=>[s(u,{name:"title",label:"Title",rules:[{required:!0,message:"Title is required"}]},{default:l(()=>[s(d,{value:n.title,"onUpdate:value":t[1]||(t[1]=r=>n.title=r),placeholder:"e.g., Team Standup"},null,8,["value"])]),_:1}),s(u,{label:"Description",name:"description"},{default:l(()=>[s(_,{value:n.description,"onUpdate:value":t[2]||(t[2]=r=>n.description=r),"auto-size":"",placeholder:"Optional notes..."},null,8,["value"])]),_:1}),p("div",Ie,[s(u,{label:"All-day",name:"all_day"},{default:l(()=>[s(G,{checked:n.all_day,"onUpdate:checked":t[3]||(t[3]=r=>n.all_day=r)},{default:l(()=>t[18]||(t[18]=[f("All-day",-1)])),_:1,__:[18]},8,["checked"])]),_:1}),s(u,{label:"Color",name:"color"},{default:l(()=>[s(O,{value:n.color,"onUpdate:value":t[4]||(t[4]=r=>n.color=r),options:ue,dropdownStyle:{padding:"6px"}},{option:l(({value:r,label:P})=>[p("div",$e,[p("span",{class:"h-4 w-4 rounded-full border border-black/10",style:K({background:r})},null,4),p("span",null,A(P),1)])]),tagRender:l(({value:r,label:P,closable:ve,onClose:pe})=>[s(i,{closable:ve,onClose:pe,class:"rounded-full",style:K({background:r,color:"#fff",border:"none"})},{default:l(()=>[f(A(P),1)]),_:2},1032,["closable","onClose","style"])]),_:1},8,["value"])]),_:1})]),p("div",Pe,[s(u,{label:"Start",name:"start",rules:[{required:!0,message:"Start is required"}]},{default:l(()=>[s(c,{value:n.start,"onUpdate:value":t[5]||(t[5]=r=>n.start=r),"show-time":!n.all_day,"value-format":n.all_day?"YYYY-MM-DD":"YYYY-MM-DDTHH:mm:ssZ",style:{width:"100%"}},null,8,["value","show-time","value-format"])]),_:1}),s(u,{label:"End",name:"end"},{default:l(()=>[s(c,{value:n.end,"onUpdate:value":t[6]||(t[6]=r=>n.end=r),"show-time":!n.all_day,"value-format":n.all_day?"YYYY-MM-DD":"YYYY-MM-DDTHH:mm:ssZ",style:{width:"100%"}},null,8,["value","show-time","value-format"])]),_:1})]),p("div",Le,[s(u,{label:"Location",name:"location"},{default:l(()=>[s(d,{value:n.location,"onUpdate:value":t[7]||(t[7]=r=>n.location=r),placeholder:"Optional"},null,8,["value"])]),_:1}),s(u,{label:"Tags (meta.tags)"},{default:l(()=>[s(d,{value:(n.meta?.tags||[]).join(", "),"onUpdate:value":t[8]||(t[8]=r=>{n.meta={...n.meta||{},tags:r.split(",").map(P=>P.trim()).filter(Boolean)}}),placeholder:"Comma separated"},null,8,["value"])]),_:1})]),p("div",ze,[s(L(De),null,{default:l(()=>[s(o,{onClick:t[9]||(t[9]=r=>b.value=!1)},{default:l(()=>t[19]||(t[19]=[f("Cancel",-1)])),_:1,__:[19]}),s(o,{type:"primary",onClick:re},{default:l(()=>[f(A(k.value?"Save":"Create"),1)]),_:1})]),_:1}),k.value?(x(),S(L(Ee),{key:0,title:"Delete this event?","ok-text":"Delete","ok-type":"danger",onConfirm:ie},{default:l(()=>[s(o,{danger:""},{default:l(()=>t[20]||(t[20]=[f("Delete",-1)])),_:1,__:[20]})]),_:1})):q("",!0)])]),_:1},8,["model"])]),_:1},8,["open","title"])])]),_:1})}}}),Je=Me(Ne,[["__scopeId","data-v-00d18dfc"]]);export{Je as default};
